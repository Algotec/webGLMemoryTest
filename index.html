<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebGL Memory Stress Test</title>
</head>
<body>
<head>
    <meta charset="UTF-8">
    <title>webGLMemoryTest by Algotec</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
</head>
<section class="page-header">
    <h1 class="project-name">webGLMemoryTest</h1>
    <h2 class="project-tagline">Create WebGL textures until running out of memory. Crashes chrome, works in IE and firefox</h2>
    <a href="https://github.com/Algotec/webGLMemoryTest" class="btn">View on GitHub</a>
    <a href="https://github.com/Algotec/webGLMemoryTest/zipball/master" class="btn">Download .zip</a>
    <a href="https://github.com/Algotec/webGLMemoryTest/tarball/master" class="btn">Download .tar.gz</a>
</section>

<section class="main-content">
    <h1>
        <a id="webGLMemoryTest" class="anchor" href="#webGLMemoryTest" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>webGLMemoryTest
    </h1>

    <p>Create WebGL textures until running out of memory.</p>

    <p>IE, Edge and FireFox return the correct error (gl.OUT_OF_MEMORY), and allow for recovery.</p>

    <p>Chrome returns gl.CONTEXT_LOST_WEBGL and does not allow recovery. </p>

    <p>Any further WebGL call will prompt "Rats! WebGL hit a snag", and the user must reload the page. </p>

    <p>documented with chromium with issue <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=93857">93857</a></p>
    <br/>

    <button id="start">Increase Memory</button>
    <script>
        var canvas, gl, sampleImage, textures, loseContextExt, timeoutMemoryLoop;
        var WIDTH = 1024, HEIGHT = 1024;
        var isIE = /*@cc_on!@*/false || !!document.documentMode;
        var isEdge = !isIE && !!window.StyleMedia;
        sampleImage = new Uint8Array(WIDTH * HEIGHT * 4);

        initWebGL();


        document.querySelector("#start").addEventListener('click', function (ev) {
            increaseMemoryLoop();
        });

        function initWebGL() {
            canvas = document.createElement("canvas");
            canvas.addEventListener("webglcontextlost", function(e) {
                console.log('context lost');
                e.preventDefault();
                clearTimeout(timeoutMemoryLoop);
                handleError(gl.CONTEXT_LOST_WEBGL);
                loseContextExt.restoreContext();
            }, false);
            canvas.addEventListener("webglcontextrestored", function (event) {
                console.log('context restored');
                initWebGL();
            }, false);
            gl = (isEdge || isIE) ? canvas.getContext("experimental-webgl") : canvas.getContext("webgl") ;
            loseContextExt = gl.getExtension("WEBGL_lose_context");
            textures = [];
        }

        function increaseMemoryLoop() {
            var texture = gl.createTexture();
            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, WIDTH, HEIGHT, 0, gl.RGBA, gl.UNSIGNED_BYTE, sampleImage);
            var error = gl.getError();
            gl.bindTexture(gl.TEXTURE_2D, null);

            if (error === gl.NO_ERROR) {
                textures.push(texture);
                timeoutMemoryLoop = setTimeout(increaseMemoryLoop, 0);
            } else {
                handleError(error);
            }
        }

        function handleError(error) {
            alert('WebGL out of memory after ' + textures.length * WIDTH * HEIGHT * 4 + ' bytes. Error (' + translateGLError(error) + ")");
            releaseMemory();
        }
        function releaseMemory() {
            textures.forEach(function (texture) {
                gl.deleteTexture(texture);
            });
            canvas = null;
            gl = null;
            sampleImage = null;
            textures = null;
        }

        function translateGLError(error) {
            try {
                switch (error) {
                    case gl.NO_ERROR: return "NO_ERROR";
                    case gl.INVALID_ENUM: return "INVALID_ENUM";
                    case gl.INVALID_VALUE: return "INVALID_VALUE";
                    case gl.INVALID_OPERATION: return "INVALID_OPERATION";
                    case gl.INVALID_FRAMEBUFFER_OPERATION: return "INVALID_FRAMEBUFFER_OPERATION";
                    case gl.OUT_OF_MEMORY: return "OUT_OF_MEMORY";
                    case gl.CONTEXT_LOST_WEBGL: return "CONTEXT_LOST_WEBGL";
                }
            } catch (ex) {
                console.log(ex);
            }
            return "UNKNOWN";
        }
    </script>
</section>

<footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/Algotec/webGLMemoryTest">webGLMemoryTest</a> is maintained by <a
                href="https://github.com/Algotec">Algotec</a>.</span>

    <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a
            href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
</footer>

</body>
</html>